---
title: "Homework 07"
author: "Spencer Pease"
date: "11/27/2019"
output: pdf_document
---

```{r setup, include=FALSE}

# Set output options
knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '-')

# Include libraries
library(uwIntroStats)
library(magrittr)
library(dplyr)
library(ggplot2)

# Helper functions


# Prepare data
mri <-
  read.table("data/mri.txt", header = TRUE) %>%
  dplyr::as_tibble() %>%
  dplyr::select(age, crt, obstime) %>%
  dplyr::filter(!is.na(crt)) %>%
  dplyr::mutate(
    surv = dplyr::if_else(obstime >= 5 * 365.25, 1L, 0L),
    ln_crt = log(crt)
  )

```


# _(Q1)_ Serum Creatinine Level and 5-Year All-Cause Mortality

## _(Q1.a)_

```{r}

lm_surv <- regress("geometric", crt ~ surv, data = mri)

coef_surv <- lm_surv$coefficients[, 1]
model_gm <- c(exp(coef_surv[[1]]), exp(sum(coef_surv)))

mri_summary <- mri %>%
  group_by(surv) %>%
  summarise(
    arith_mean = mean(crt),
    geo_mean = exp(mean(log(crt)))
  )

```

The model fit to determine the nature of the association between serum
creatinine level ($crt$) and 5-year all-cause mortality binary survival status
($surv$) is expressed as:

$$ E[Log(crt_{i}) | surv_{i}] = \beta_{0} + \beta_{1} \cdot surv_{i}$$

With $\beta_{0} =$ `r round(coef_surv[[1]], 3)` and
$\beta_{1} =$ `r round(coef_surv[[2]], 3)`.


## _(Q1.b,c)_

In this model, the intercept is interpreted as the log of the geometric mean of
the response variable (_crt_) when the predictor (_surv_) is $0$. This has a
relevant scientific interpretation, since the exponentiated intercept is the
geometric mean of creatinine level in the population of subjects who did not
survive at least 5 years.

The slope of this model is interpreted as the the log of the ratio of the
geometric means of the response between two groups differing by one unit of our
predictor. Again, this has a relevant scientific interpretation as the
exponentiated slope is the ratio of the geometric mean creatinine levels
between the population that survived at least 5 years and the population that
didn't. Using this and the intercept, we can find the geometric mean of the
subset of individuals who survived at least 5 years.


## _(Q1.d,e)_

**Using the regression model estimates:**

 * $GM(crt)$ for a population surviving $\ge 5$ years = $e^{\beta_{0}}$ =
   `r round(model_gm[2], 3)`
 * $GM(crt)$ for a population surviving $< 5$ years =
   $e^{(\beta_{0}+\beta_{1})}$ = `r round(model_gm[1], 3)`

**Calculating the geometric mean directly:**

 * $GM(crt)$ for a population surviving $\ge 5$ years =
   `r round(mri_summary[[2, 3]], 3)`
 * $GM(crt)$ for a population surviving $< 5$ years =
   `r round(mri_summary[[1, 3]], 3)`

Using either the model estimates or direct calculation of the geometric mean
produce the same results, showing that the geometric linear model can be used
to determine the population geometric mean for populations set by the
predictor value.


## _(Q1.f)_

```{r}

surv_inf_tbl <- lm_surv$transformed %>%
  as_tibble() %>%
  select(-`F stat`, -`df`) %>%
  magrittr::set_colnames(c("Estimate", "2.5%", "97.5%", "P-val")) %>%
  mutate(`P-val` = paste0(round(`P-val` * 10^5, 2), "e-5")) %>%
  slice(2)

knitr::kable(
  surv_inf_tbl,
  booktabs = TRUE,
  digits = 3,
  caption = paste("Statistical inference for ratio of geometric means between",
                  "survivorship groups")
)

```


From a linear regression analysis of the log-transformed serum creatinine level
and binary 5-year all-cause mortality using Huber-White estimates of the
standard error, we find that the population of individuals who survive at least
five years form their observation date have a geometric mean creatinine level
`r round(surv_inf_tbl[[1, 1]], 3)` times the value of the the geometric mean
of the population that survives less than five years. A $95\%$ confidence
interval suggests this ratio is not unusual if the true ratio of geometric
means is between `r round(surv_inf_tbl[[1, 2]], 3)` and
`r round(surv_inf_tbl[[1, 3]], 3)`. Because this interval does not include $1$,
and the two-sided _P_-value is less than $.05$, we reject the null hypothesis
that there is no linear trend in serum creatinine level across survival status
groups.


# _(Q2)_ Serum Creatinine Level and Age

## _(Q2.a)_

```{r}

p_scatter <- ggplot(mri, aes(x = age, y = ln_crt)) +
  geom_point(size = 2) +
  theme_bw() +
  geom_smooth(method = "lm", se = FALSE, size = 1.5, color = "maroon") +
  labs(
    title = "Log(Serum Creatinine Level) vs Age",
    x = "Age (years)",
    y = "Log(Serum Creatinine Level)"
  ) +
  theme(text = element_text(family = "serif"))

p_scatter

```


## _(Q2.b)_

```{r}

lm_age <- regress("geometric", crt ~ age, data = mri)
coef_age <- lm_age$coefficients[, 1]

```

The model fit to determine the nature of the association between serum
creatinine level ($crt$) and age ($age$) is expressed as:

$$ E[Log(crt_{i}) | age_{i}] = \beta_{0} + \beta_{1} \cdot age_{i}$$

With $\beta_{0} =$ `r round(coef_age[[1]], 3)` and
$\beta_{1} =$ `r round(coef_age[[2]], 3)`.


## _(Q2.c,d)_

The intercept of this model ($\beta_{0}$) represents the log of the geometric
mean of our response variable (_crt_) when the predictor (_age_) is $0$. This
has no scientific interpretation, as a newborn child is far outside of the range
of ages for which we have observations, meaning the model doesn't have any
power that far from our observations.

The slope of this model ($\beta_{1}$) represents the log of the ratio of the
geometric means of the response between two groups separated by one unit of the
predictor ($1$ year). This has a meaningful scientific interpretation, as the
exponentiated slope is the ratio of the geometric means between two age groups
one year apart. Within the range of our observed data, this can be used to
determine the geometric mean for any age group.


## _(Q2.e,f)_

```{r}

lm_age_arith <- lm(crt ~ age, data = mri)
pred_age_arith <- predict(lm_age_arith, data.frame(age = c(72, 85, 95)))
pred_age <- predict(lm_age, newdata = data.frame(age = c(72, 85, 95)))

estimate_tbl <- tibble(
  `Age` = c(72, 85, 95),
  `Est. geometric mean crt` = exp(pred_age[,1 ]),
  `Est. Arithmetic mean crt` = pred_age_arith
)

knitr::kable(
  estimate_tbl,
  booktabs = TRUE,
  digits = 3,
  caption = paste("Estimated mean serum creatinine levels for both geometric",
                  "and linear models")
)


```

Comparing predictions between our log-transformed linear model and a standard
linear model using the same predictor/response variables, we see that while
predictions across the models are generally, similar, there is a definite trend
of the geometric mean increasing at a slower rate than the arithmetic mean as
age increases. This can be explained by the fact that the geometric mean is
less biased towards outliers than the arithmetic mean.


## _(Q2.g)_

```{r}

age_inf_tbl <- lm_age$transformed %>%
  as_tibble() %>%
  select(-`F stat`, -`df`) %>%
  magrittr::set_colnames(c("Estimate", "2.5%", "97.5%", "P-val")) %>%
  slice(2)

knitr::kable(
  age_inf_tbl,
  booktabs = TRUE,
  digits = 3,
  caption = paste("Statistical inference for ratio of geometric means between",
                  "one year age groups")
)

```

From a linear regression analysis of the log-transformed serum creatinine level
and patient age using Huber-White estimates of the standard error, we estimate
that for every one year increase in age an age group's geometric mean creatinine
level is `r round(age_inf_tbl[[1, 1]], 3)` time higher. A $95\%$ confidence
interval suggests this ratio is not unusual if the true ratioo of geometric
means is between `r round(age_inf_tbl[[1, 2]], 3)` and
`r round(age_inf_tbl[[1, 3]], 3)`. Becuase this interval includes $1$, and the
_P_-value is greater than $.05$ we do not reject the null hypothesis that there
is no linear association between serum creatinine level and age.


## _(Q2.h)_

```{r}

est_tbl_10yr <- tibble(
  `Estimate` = 10 * 100 * (age_inf_tbl[[1, 1]] - 1),
  `95% CI (lower)` = 10 * 100 * (age_inf_tbl[[1, 2]] - 1),
  `95% CI (upper)` = 10 * 100 * (age_inf_tbl[[1, 3]] - 1)
)

knitr::kable(
  est_tbl_10yr,
  booktabs = TRUE,
  digits = 2,
  caption = paste("Estimate of the percent change in geometric means between",
                  "two age groups 10 years apart")
)

```

