---
title: "Homework 04"
author: "Spencer Pease"
date: "10/28/2019"
output: pdf_document
---

```{r setup, include=FALSE}

# Set output options
knitr::opts_chunk$set(echo = FALSE)
options(knitr.kable.NA = '-')

# Include libraries
library(magrittr)

# Source helper functions
source("functions/population_estimates.R")
source("functions/diagnostic_tests.R")

```

# _(Q1)_ Creatinine Levels and Survivorship Status

One way we can examine data from the MRI data set is by dichotomizing variable
to see the size of different category pairings. In this question we will look at
two such variables: _5-year vital status_ (did the patient live longer than
five years after their MRI date) and _high creatinine level_ (is the patient's
creatinine level **above** $1.2 \frac{mg}{dl}$).

```{r mri-data}

# Load data
mri <-
  read.table("data/mri.txt", header = TRUE) %>%
  dplyr::as_tibble() %>%
  dplyr::select(.data$crt, .data$obstime) %>%
  dplyr::filter(!is.na(.data$crt)) %>%
  dplyr::transmute(
    `Surv. 5+ years` = dplyr::if_else(.data$obstime >= 5 * 365, 1, 0),
    `High CRT` = dplyr::if_else(.data$crt > 1.2, 1, 0)
  )

```


## _(Q1.a)_

To better compare the different categories created by the mixing of these two
variables, we create a contingency table:

```{r mri-contingency-table}

mri %>%
  xtabs(~`Surv. 5+ years` + `High CRT`, data = .) %>%
  magrittr::set_rownames(c("Died w/in 5 years", "Surv. 5+ years")) %>%
  magrittr::set_colnames(c("Non-high CRT", "High CRT")) %>%
  knitr::kable(
    caption = paste(
      "Contingency table for each pairing of the dichotomous variables",
      "'Survival Status' and 'CRT Level'.")
    )

```


## _(Q1.b-e)_

If we want to look closer at the relationship between survival status and
high creatinine level, we can use inferential statistics to make estimates about
different groups within our population. For each grouping condition below, we
look at the point estimate of the mean, standard error, and $95\%$ confidence
interval.

```{r mri-prob-estimates}

mri_probs <- mri %>%
  dplyr::group_by(.data$`Surv. 5+ years`, .data$`High CRT`) %>%
  dplyr::summarise(count = dplyr::n(), prob = dplyr::n() / nrow(mri))

pr <- mri_probs$prob

mri_inf_table <-
  tibble::tribble(
    ~Condition, ~`Point est.`,
    "Survive 5+ years", sum(pr[3:4]),
    "Low CRT level", sum(pr[c(1, 3)]),
    "Low CRT level, given survival of <5 years", pr[1] / sum(pr[1:2]),
    "Survive 5+ years, given high CRT level", pr[4] / sum(pr[c(2, 4)])
  ) %>%
  dplyr::mutate(
    `Std. error` =  se_prop(.data$`Point est.`, nrow(mri)),
    `95% CI (lower)` = ci_prop(.data$`Point est.`, nrow(mri))[["lower"]],
    `95% CI (upper)` = ci_prop(.data$`Point est.`, nrow(mri))[["upper"]]
  )

knitr::kable(
  mri_inf_table,
  digits = 2,
  caption = paste(
    "Summary of the point estimate, standard error, and 95% confidence",
    "interval of the population probability, for various conditions.")
  )

```


# _(Q2)_ The ELISA Test

## _(Q2.a,b)_

```{r}

ppv <- gen_ppv(sens = .99, spec = .96, prev = .01)
npv <- gen_npv(sens = .99, spec = .96, prev = .01)

```

For a test with $99\%$ sensitivity and $96\%$ specificity, in a population of
people donating blood with a prevalence of HIV-infection at $1\%$, the 
predictive values of the test are:

 * Positive predictive value: **`r round(ppv, 2)`**
 * Negative predictive value: $1 - (1 \times 10^{-4})$


## _(Q2.c)_

Even though the test may have a specificity of _"only $96\%$"_, it is important
to consider what this means in the context of the population in which the test
is being used. In this case, the prevalence of HIV is $1\%$, which means the
test will only be wrong $4\%$ of the time for this small fraction of the
population. Overall, this means very few individuals with HIV will test negative
when donating blood.


## _(Q2.d)_

For a test used to keep HIV out of the blood supply of blood banks, it is more
important to have a high specificity. In the scheme of things, rejecting someone
from donating because they falsely test positive for HIV is far less 
consequential than accepting someone who falsely tests negative. For this reason,
it is more important to have confidence in the test when it produces negative
results, which is captured in the specificity of the test.


## _(Q2.e)_

```{r}

ppv2 <- gen_ppv(sens = .99, spec = .96, prev = .16)
npv2 <- gen_npv(sens = .99, spec = .96, prev = .16)

```

For the same test used in a clinic with a high number of intravenous drug users 
where the prevalence of HIV-infection is now $16\%$, the predictive values of 
the test are:

 * Positive predictive value: **`r round(ppv2, 2)`**
 * Negative predictive value: **`r round(npv2, 3)`**


## _(Q2.f)_

```{r}

ppv3 <- gen_ppv(sens = .99, spec = .96, prev = .0001)
npv3 <- gen_npv(sens = .99, spec = .96, prev = .0001)

```

Finally, for the same test in a population of students entering college where 
the HIV-infection prevalence is $.01\%$, the predictive values of the test are:

 * Positive predictive value: **`r round(ppv3, 3)`**
 * Negative predictive value: $1 - (1 \times 10^{-5})$


# _(Q3)_ A Biased Coin

```{r}

prob_h <- .65
prob_t <- .35
tosses <- 5

q3_answers <- list(
  "a" = prob_h * prob_t^4,
  "b" = sum(dbinom(3:5, size = tosses, prob = prob_h)),
  "c" = 1 / 5,
  "d" = prob_h * tosses
)

```

 a) $X=1$ and $Y=1$: $9.75 \times 10^{-3}$
 b) $Y \geq 3$: **`r round(q3_answers$b, 3)`**
 c) $X=1$ given $Y=1$: **`r q3_answers$c`**
 d) $E(Y)$: **`r q3_answers$d`**
